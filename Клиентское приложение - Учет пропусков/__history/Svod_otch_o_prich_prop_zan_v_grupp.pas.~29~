unit Svod_otch_o_prich_prop_zan_v_grupp;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, Grids, DBGrids, ComCtrls, StdCtrls, Buttons, ExtCtrls, jpeg, DBCtrls,
  excel2000,comobj,ShellApi;

type
  TFSvod_otch_o_prich_prop_zan_v_grupp = class(TForm)
    DBGrid1: TDBGrid;
    Panel3: TPanel;
    Image1: TImage;
    Label1: TLabel;
    Label2: TLabel;
    BitBtn1: TBitBtn;
    DateTimePicker1: TDateTimePicker;
    DateTimePicker2: TDateTimePicker;
    Label3: TLabel;
    DBLookupComboBox1: TDBLookupComboBox;
    BitBtn2: TBitBtn;
    procedure DateTimePicker1Change(Sender: TObject);
    procedure FormActivate(Sender: TObject);
    procedure BitBtn2Click(Sender: TObject);
    procedure BitBtn1Click(Sender: TObject);

  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  FSvod_otch_o_prich_prop_zan_v_grupp: TFSvod_otch_o_prich_prop_zan_v_grupp;
  OE1,OList :Variant;
  istr:integer;
  s:string;
  f:textfile;
implementation

uses DM;

{$R *.dfm}

procedure TFSvod_otch_o_prich_prop_zan_v_grupp.BitBtn1Click(Sender: TObject);
begin

OE1:=CreateOleObject('Excel.Application'); //СоздатьOLE-объект Excel
OE1.WorkBooks.Add();                      // Создать рабочую книгу Excel
OE1.Visible:=True;                         // Сделать Excel видимым
//Занести в ячейку значение- напечатать заголовок отчета
OE1.Cells[1,1].Value:='Сводный отчет о пропусках занятий по группе '+
'За период'+' '+'c'+' '+DateToStr(DateTimePicker1.Date)+' '+'по'+' '+DateToStr(DateTimePicker2.Date);
//OE1.Cells[2,1].Value:='№ Студента';
OE1.Cells[2,2].Value:='ФИО студента';
OE1.Cells[2,3].value:='Пропущено часов';
OE1.Cells[2,4].Value:='по болезни';
OE1.Cells[2,5].Value:='МСЭК';
OE1.Cells[2,6].Value:='Заявление';
OE1.Cells[2,7].Value:='Раз.администрации';
OE1.Cells[2,8].Value:='Другие причины';
OE1.Cells[2,9].Value:='Прогулы';


istr:=3;                           // Номер
fdm.ADOQueryOtch.First;               //Перейти на первую запись
while not fdm.ADOQueryOtch.Eof do  // Пока не будет достигнут конец файла
begin
//Заносить в ячейку Excel содержимое полей
OE1.Cells[istr,1].Value:=fdm.ADOQueryOtch.FieldByName('№_Студента').AsString;
OE1.Cells[istr,2].Value:=fdm.ADOQueryOtch.FieldByName('ФИО_Студента').AsString;
OE1.Cells[istr,3].Value:=fdm.ADOQueryOtch.FieldByName('Пропущено_часов').AsString;
OE1.Cells[istr,4].Value:=fdm.ADOQueryOtch.FieldByName('По_Болезни').AsString;
OE1.Cells[istr,5].Value:=fdm.ADOQueryOtch.FieldByName('МСЭК').AsString;
OE1.Cells[istr,6].Value:=fdm.ADOQueryOtch.FieldByName('Заявление').AsString;
OE1.Cells[ist,7].Value:=fdm.ADOQueryOtch.FieldByName('Раз.администрации').AsString;
OE1.Cells[istr,8].Value:=fdm.ADOQueryOtch.FieldByName('Другие_причины').AsString;
OE1.Cells[istr,9].Value:=fdm.ADOQueryOtch.FieldByName('Прогулы').AsString;


//Перейти на следующую запись
FDM.ADOQueryOtch.Next;
////Увеличить номер строки   в Excel
 istr:=istr+1;
//
end;
//begin
 //Дополнительные команды для форматирования
OE1.Range['A3:I'+IntToStr(istr+1)].Select;   // Выделить ячейки
//Обрамление сплошной линией всех выделенных ячеек
     OE1.Selection.Borders[xlEdgeLeft].LineStyle:=xlContinuous;
     OE1.Selection.Borders[xlEdgeRight].LineStyle:=xlContinuous;
     OE1.Selection.Borders[xlEdgeTop].LineStyle:=xlContinuous;
     OE1.Selection.Borders[xlEdgeBottom].LineStyle:=xlContinuous;
     OE1.Selection.Borders[xlInsideVertical].LineStyle:=xlContinuous;
 OE1.Selection.Borders[xlInsideHorizontal].LineStyle:=xlContinuous;
   // OE1.Selection.MergeCells:=True;
//OE1.Selection.HorizontalAlignment := xlLeft;
    /// OE1.Selection.VerticalAlignment := xlCenter;
     OE1.Range['A1:h'+inttostr(istr-1)].Select;
OE1.Selection.ColumnWidth:=30;// Ширина столбца

  // параметры печати - границы
        OE1.ActiveSheet.PageSetup.LeftMargin:= 0.39;
        OE1.ActiveSheet.PageSetup.RightMargin := 0.39;
        OE1.ActiveSheet.PageSetup.TopMargin := 2.78;
        OE1.ActiveSheet.PageSetup.BottomMargin := 0.78;
  // параметры печати - ориентация
        OE1.ActiveSheet.PageSetup.Orientation := xlLandscape;
        OE1.ActiveSheet.PageSetup.Zoom := False ;
// Расположить на 1 странице по ширине        OE1.ActiveSheet.PageSetup.FitToPagesWide := 1
// Расположить на 10 страницах по высоте        OE1.ActiveSheet.PageSetup.FitToPagesTall := 10;
//Правый колонтитул внизу
OE1.ActiveSheet.PageSetup.RightFooter := DateToStr(Date) ;
//Предварительный просмотр
OE1.ActiveSheet.PrintPreview;
end;

procedure TFSvod_otch_o_prich_prop_zan_v_grupp.BitBtn2Click(Sender: TObject);
begin

//// 1.открыть файл раширение html
////2. вывести в файл информацию на языке html
//закрыть файл
//запустить файл

 assignfile(f,extractfiledir(Application.ExeName)+'\Сводный отчет о пропусках занятий по группе.html');
ReWrite(f);
writeln(f,'<html>');
writeln(f,'<head>');
writeln(f,'<LINK  REL=STYLESHEET  TYPE=text/css HREF=table.css>');
writeln(f,'</head>');
writeln(f,'<body>');
writeln(f,'<p></p>');
writeln(f,'<table>');
writeln(f,'<th>'+'№ Студента'+'</th>');
writeln(f,'<th>'+'ФИО студента'+'</th>');
writeln(f,'<th>'+'Пропущено часов'+'</th>');
writeln(f,'<th>'+'По болезни'+'</th>');
writeln(f,'<th>'+'МСЭК'+'</th>');
writeln(f,'<th>'+'Заявление'+'</th>');
writeln(f,'<th>'+'Раз.администрации'+'</th>');
writeln(f,'<th>'+'Другие причины'+'</th>');
writeln(f,'<th>'+'Прогулы'+'</th>');
fdm.ADOQueryOtch.First;               //Перейти на первую запись
while not fdm.ADOQueryOtch.Eof do
  begin
writeln(f,'<tr>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('№_Студента').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('ФИО_студента').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('Пропущено_часов').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('По_болезни').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('МСЭК').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('Заявление').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('Раз_администрации').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('Другие_причины').AsString+ '</td>');
writeln(f,'<td>'+fdm.ADOQueryOtch.FieldByName('Прогулы').AsString+ '</td>');
writeln(f,'</tr>');
FDM.ADOQueryOtch.Next;
end;
writeln(f,'</table>');
writeln(f,'</body>');
writeln(f,'</html>');
closefile(f);
shellexecute(Handle,'open',Pchar(extractfiledir(Application.ExeName)+'\Сводный отчет о пропусках занятий по группе.html'),nil,nil,SW_SHOWNORMAL);

end;

procedure TFSvod_otch_o_prich_prop_zan_v_grupp.DateTimePicker1Change(
  Sender: TObject);
begin
fdm.ADOQueryOtch.SQL.Text:='exec Svod_otcht_o_propuskah_po_gruppe ' +
IntToStr(fdm.ADOQueryVvodGrupp.FieldByName('N_Grupp').Value)+','+
QuotedStr(DateToStr(DateTimePicker1.date))+','+
QuotedStr(DateToStr(DateTimePicker2.Date));
fdm.ADOQueryOtch.Close;
fdm.ADOQueryOtch.Open;
 DBGrid1.Columns.Items[0].Title.Caption :='№ Студента';
 DBGrid1.Columns.Items[1].Title.Caption :='ФИО студента';
 DBGrid1.Columns.Items[2].Title.Caption :='Пропущено часов';
 DBGrid1.Columns.Items[3].Title.Caption :='По болезни';
 DBGrid1.Columns.Items[4].Title.Caption :='МСЭК';
 DBGrid1.Columns.Items[5].Title.Caption :='Заявление';
 DBGrid1.Columns.Items[6].Title.Caption :='Раз.администрации';
 DBGrid1.Columns.Items[7].Title.Caption :='Другие причины';

end;


procedure TFSvod_otch_o_prich_prop_zan_v_grupp.FormActivate(Sender: TObject);
begin
DateTimePicker1.Date:=date;
DateTimePicker2.Date:=date;
fdm.ADOQueryVvodGrupp.Open;
end;

end.
